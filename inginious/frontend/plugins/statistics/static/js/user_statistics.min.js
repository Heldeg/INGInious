var CsvConverter=function(){function t(t){this.data=t}return t.prototype.downloadCsv=function(){var t="data:text/csv;charset=utf-8,"+Papa.unparse(this.data),e=encodeURI(t),s=document.createElement("a");s.setAttribute("href",e),s.setAttribute("download","export.csv"),document.body.appendChild(s),s.click(),s.remove()},t}(),Statistic=function(){function t(){this._cachedPromise=null}return t.prototype._fetchAndCacheData=function(){return null==this._cachedPromise&&(this._cachedPromise=this._fetchData()),this._cachedPromise},t.prototype.plotAsync=function(){var t=this;this._fetchAndCacheData().then(function(e){t._plotData(e)})},t.prototype._fetchCsvData=function(){return this._fetchAndCacheData()},t.prototype.downloadCsvAsync=function(){this._fetchCsvData().then(function(t){new CsvConverter(t).downloadCsv()})},t.prototype._plotData=function(t){throw"Not implemented"},t.prototype._fetchData=function(){throw"Not implemented"},t}();function createSubmissionLink(t){return _.template("/submission/${ submissionId }")({submissionId:t})}function generateVerdictSubmissionTable(t,e){var s=$("#"+t);s.html("<thead><tr><th>Username</th><th>Grade</th><th>Status</th><th>Summary result</th><th>Submitted on</th><th>Submission</th></tr></thead>");for(var a=$("<tbody/>"),i=0;i<e.length;++i){for(var r=$("<tr/>"),o=e[i],n=[o.username,o.grade,o.status||"-",o.summary_result||"-",o.submitted_on||"-"],c=0;c<n.length;++c){var u=$("<td/>");u.text(n[c]),r.append(u)}var h=$("<td/>");if(o.id){var d=$("<a>",{text:o.id,href:createSubmissionLink(o.id)});h.append(d)}else h.text("No submission available");r.append(h),a.append(r)}s.append(a)}function generateSubmissionTable(t,e){var s=$("#"+t);s.html("<thead><tr><th>Username</th><th>Grade</th><th>Status</th><th>Summary result</th><th>Submitted on</th><th>Submission</th></tr></thead>");for(var a=$("<tbody/>"),i=0;i<e.length;++i){for(var r=$("<tr/>"),o=e[i],n=o.submission||{},c=[o.username,o.grade,n.status||"-",n.summary_result||"-",n.submitted_on||"-"],u=0;u<c.length;++u){var h=$("<td/>");h.text(c[u]),r.append(h)}var d=$("<td/>");if(n.id){var l=$("<a>",{text:n.id,href:createSubmissionLink(n.id)});d.append(l)}else d.text("No submission available");r.append(d),a.append(r)}s.append(a)}function createAlertHtml(t,e){return'<div class="alert '+t+' alert-dismissible" role="alert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>'+e+"</div>"}var UserStatistics={colors:{COMPILATION_ERROR:"rgb(236,199,6)",TIME_LIMIT_EXCEEDED:"rgb(50,120,202)",MEMORY_LIMIT_EXCEEDED:"rgb(119,92,133)",RUNTIME_ERROR:"rgb(2,164,174)",WRONG_ANSWER:"rgb(227,79,54)",INTERNAL_ERROR:"rgb(137,139,37)",ACCEPTED:"rgb(35,181,100)"}},UserTrialsAndBestGradeStatistic=function(){function t(t){this.course_id=t,this.div_id="tries_per_task",this.RESOURCE_URL="/api/stats/student/trials_and_best_grade"}return t.prototype=Object.create(Statistic.prototype),t.prototype._fetchData=function(){return $.getJSON(this.RESOURCE_URL,{course_id:this.course_id})},t.prototype._plotData=function(t){for(var e=this._getRatio(t),s={},a=Object.keys(UserStatistics.colors),i=0;i<a.length;i++)s[a[i]]={mode:"markers",name:a[i],marker:{color:UserStatistics.colors[a[i]],sizemode:"area",sizeref:e,size:[]},text:[],x:[],y:[]};for(i=0;i<t.length;i++){var r=t[i].result;s[r].x.push(t[i].task_name),s[r].y.push(t[i].grade),s[r].text.push(t[i].tried+" submissions"),s[r].marker.size.push(t[i].tried)}var o=[];for(i=0;i<a.length;i++)o.push(s[a[i]]);Plotly.purge(this.div_id),Plotly.plot(this.div_id,o,{xaxis:{title:"Task"},yaxis:{title:"Grade",range:[-10,110]},margin:{t:20},hovermode:"closest"},{showLink:!1})},t.prototype._getRatio=function(t){for(var e=0,s=0;s<t.length;s++)e+=t[s].tried;return e/t.length/1e3},t}(),BarSubmissionsPerTasks=function(){function t(t,e){this.course_id=t,this.id_div=e||"submissions_per_task",this.RESOURCE_URL="/api/stats/student/bar_submissions_per_tasks",this.normalize=!1}return t.prototype=Object.create(Statistic.prototype),t.prototype._fetchData=function(){return $.getJSON(this.RESOURCE_URL,{course_id:this.course_id})},t.prototype.toggleNormalize=function(){this.normalize=!this.normalize,this.plotAsync()},t.prototype._plotData=function(t){for(var e={},s=[],a=0;a<t.length;++a)null==e[t[a].task_name]&&(e[t[a].task_name]=0,s.push(t[a].task_name)),e[t[a].task_name]+=t[a].count;var i=UserStatistics.colors,r=[this.createObjectToPlotData(t,e,"COMPILATION_ERROR",i.COMPILATION_ERROR),this.createObjectToPlotData(t,e,"TIME_LIMIT_EXCEEDED",i.TIME_LIMIT_EXCEEDED),this.createObjectToPlotData(t,e,"MEMORY_LIMIT_EXCEEDED",i.MEMORY_LIMIT_EXCEEDED),this.createObjectToPlotData(t,e,"RUNTIME_ERROR",i.RUNTIME_ERROR),this.createObjectToPlotData(t,e,"WRONG_ANSWER",i.WRONG_ANSWER),this.createObjectToPlotData(t,e,"INTERNAL_ERROR",i.INTERNAL_ERROR),this.createObjectToPlotData(t,e,"ACCEPTED",i.ACCEPTED)],o={barmode:"stack",title:"Submissions vs Task",xaxis:{title:"Tasks",categoryorder:"array",categoryarray:s,titlefont:{size:16,color:"rgb(107, 107, 107)"}},yaxis:{title:this.normalize?"Percentage of submissions":"Number of submissions",titlefont:{size:16,color:"rgb(107, 107, 107)"}}};Plotly.purge(this.id_div),Plotly.newPlot(this.id_div,r,o)},t.prototype.createObjectToPlotData=function(t,e,s,a){for(var i={x:[],y:[],marker:{color:a},name:s,type:"bar"},r=0;r<t.length;++r)t[r].summary_result===s&&(i.x.push(t[r].task_name),this.normalize?i.y.push(t[r].count/e[t[r].task_name]*100):i.y.push(t[r].count));return i},t}();$(function(){UserStatistics.course_id=getCourseId(),UserStatistics.trialsAndBestGradeStatistic=new UserTrialsAndBestGradeStatistic(UserStatistics.course_id),UserStatistics.barSubmissionsPerTasks=new BarSubmissionsPerTasks(UserStatistics.course_id);var t={"trials-circle-tab":UserStatistics.trialsAndBestGradeStatistic,"bar-submissions-per-tasks-tab":UserStatistics.barSubmissionsPerTasks};$('a[data-toggle="tab"]').on("shown.bs.tab",function(e){var s=t[e.target.id];s&&s.plotAsync()}),$('.active > a[data-toggle="tab"]').trigger("shown.bs.tab")});