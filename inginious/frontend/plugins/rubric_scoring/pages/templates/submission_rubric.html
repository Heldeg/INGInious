$def with (course, task_id, submission_code, problem_id, rubrica, data, language, comment, score)

$var title: $:course.get_name(user_manager.session_language()) - Rubric Scoring

$def NavbarF():
    <ol class="nav navbar-nav nav-breadcrumb">
        <li><a href="$get_homepath()/course/$course.get_id()">$course.get_name(user_manager.session_language())</a></li>
    <li><a href="$get_homepath()/admin/$course.get_id()/$data['url']/task/$task_id.get_id()">$task_id.get_id()</a></li>
        <li class="active"><a href="#"><i class="fa fa-tasks"></i>$:_("Rubric Scoring")<span class="sr-only">(current)</span></a></li>
    </ol>
$var Navbar: $:NavbarF()


<h3>$:_("Rubric scoring for Task:") $task_id.get_id() </h3>

<!-- Nav tabs -->
<ul class="nav nav-tabs" role="tablist">
    <li role="presentation" class="active">
        <a href="#sourceCode" aria-controls="sourceCode" role="tab" data-toggle="tab">$:_("Source Code")</a>
    </li>
    <li role="presentation">
        <a href="#rubricContext" aria-controls="rubricContext" role="tab" data-toggle="tab">$:_("Rubric context")</a>
    </li>

</ul>


<div class="tab-content">
    <div role="tabpanel" class="tab-pane active" id="sourceCode">
        <h4>Source code of the submission</h4>
        <div id="grade_edit_submit_status"></div>
        <form method="post">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        $course.get_name(user_manager.session_language())

                    </h3>
                </div>
                <div class="panel-body">
                    <div class="student_view">
                        <!--<p>print hi baker</p>-->

                    </div>

                    <textarea class="code-editor form-control"
                              data-x-lines="1"
                              id="codeTextArea1" name="$problem_id">$submission_code['input'][problem_id]</textarea>
                </div>
            </div>

            <div class="col-md-2">
                <button class="btn btn-default btn-md btn-block" type="button"
                        onclick="lintCode('$language','$problem_id')">Linter
                </button>
            </div>

            <div>

                <div class="col-xs-8 col-sm-4 col-lg-3">
                    <!--general information div-->
                    <div>

                        <h3>General Information</h3>
                        <table class="table table-condensed">
                            <tr>
                                <td>Author(s)</td>
                                <td>$submission_code['username'][0]</td>
                            </tr>
                            <tr>
                                <td>Task</td>
                                <td>
                                    $task_id.get_id()
                                </td>
                            </tr>
                            <tr>
                                <td>Language</td>
                                <td>
                                    $language
                                </td>
                            </tr>
                            <tr>
                                <td>Submitted on</td>
                                <td> $submission_code['submitted_on']</td>
                            </tr>
                        </table>
                    </div>

                    <div>
                        <h3>Comments</h3>

                        <textarea rows="4" cols="35" class="my-text-area" id="text_comment">$comment</textarea>
                        <!--<a href="#grade_edit_submit_status"-->
                        <!--class="btn btn-primary btn-block"-->
                        <!--type="button" onclick="comment_submit()">-->
                        <!--<i class="fa fa-save"></i> Comment-->
                        <!--</a>-->
                    </div>
                </div>
                <!--information div-->
                <div class="col-xs-8 col-sm-4 col-lg-3">
                    <div>

                        <h3>Information</h3>
                        <table class="table table-condensed">
                            <tr>
                                <td>Memory</td>
                                <td>$data['memory']</td>
                            </tr>
                            <tr>
                                <td>Test Casses</td>
                                <td>
                                    $data['test_passed']
                                </td>
                            </tr>
                            <tr>
                                <td>Verdict</td>
                                <td>
                                    $data['verdict']
                                </td>
                            </tr>

                        </table>
                    </div>

                </div>
                <!--score div-->
                <div class="container-div col-xs-8 col-sm-4 col-lg-3" style="padding-bottom: 50px;">

                    <h3>Scoring</h3>


                    <label class="radio-btn-pad">
                        <input value="grade1" name="grade" type="radio" id="grade1">
                        Grade 1

                    </label>
                    <br>

                    <label class="radio-btn-pad">
                        <input value="grade2" name="grade" type="radio" id="grade2">
                        Grade 2

                    </label>
                    <br>
                    <label class="radio-btn-pad">
                        <input value="grade3" name="grade" type="radio" id="grade3">
                        Grade 3

                    </label>
                    <br>
                    <label class="radio-btn-pad">
                        <input value="grade4" name="grade" type="radio" id="grade4">
                        Grade 4

                    </label>

                    <br>
                    <label class="radio-btn-pad">
                        <input value="grade5" name="grade" type="radio" id="grade5">
                        Grade 5

                    </label>

                    <a href="#grade_edit_submit_status"
                       class="btn btn-primary btn-block"
                       type="button" onclick="grade_submit()">
                        <i class="fa fa-save"></i> Grade
                    </a>

                </div>
            </div>
        </form>


    </div>

    <div role="tabpanel" class="tab-pane" id="rubricContext">
        <div id="rubricContextDiv">
            <table class="table sorted_table">
                <thead>
                <tr>
                    <th></th>
                    $for header in rubrica.keys():
                    <th>$header</th>
                </tr>
                </thead>
                <tbody>
                $ first_level = rubrica[list(rubrica.keys())[0]]

                $for category_index in range(len(first_level)):
                $ category_name = list(first_level[category_index])[0]
                <tr>
                    <th>$category_name</th>

                    $for level_key in rubrica:
                    $ category_content = rubrica[level_key][category_index][category_name]
                    $ category_content = "" if category_content is None else category_content

                    $ category_content_lines = category_content.split("\n")

                    <td>
                        <ul>
                            $for line in category_content_lines:
                            <li>$line</li>
                        </ul>
                    </td>
                </tr>

                </tbody>
            </table>
        </div>
    </div>
</div>


<script type="text/javascript">
    let language = convertInginiousLanguageToCodemirror("$language");
    //alert("$score");
    registerCodeEditor(document.getElementById("codeTextArea1"), language);

    document.getElementById("$score").checked = true;

</script>

<script type="text/javascript">

    function grade_submit() {
        let value_radio;
        let radios = document.getElementsByName("grade");
        let content_info = "Submission graded and stored";
        let content_danger = "Error at grading, please select a grade"

        for (let i = 0, length = radios.length; i < length; i++) {
            if (radios[i].checked) {

                value_radio = radios[i].value;

                break;
            }
        }


        jQuery.ajax({
            success: function (data) {
                studio_display_task_submit_message_rubric(content_info, "info", true);
                comment_submit();
            },
            method: "POST",

            data: {"grade": value_radio},

            error: function (request, status, error) {
                studio_display_task_submit_message_rubric(content_danger, "danger", true);
            }
        })


    }

    function studio_display_task_submit_message_rubric(content, type, dismissible) {
        let code = getAlertCode(content, type, dismissible);
        let element = document.getElementById('grade_edit_submit_status');
        document.getElementById('grade_edit_submit_status').innerHTML = code;
        element.style.display = 'block';
        if (dismissible) {
            let op = 1;  // initial opacity
            let timer = setInterval(function () {
                if (op <= 0.1) {
                    clearInterval(timer);
                    element.style.display = 'none';

                }
                element.style.opacity = op;
                element.style.filter = 'alpha(opacity=' + op * 100 + ")";
                op -= op * 0.01;
            }, 50);

        }
    }

    function comment_submit() {

        let txt_comment = document.getElementById("text_comment");
        let content_info = "Comment has stored";
        let content_danger = "Error at saving Comment, please try again."
        let content_warning = "Error at saving Comment, comment to long, max length of comment is 1000."
        let maxTam = 1000;

        if (txt_comment.value.length > maxTam) {
            studio_display_task_submit_message_rubric(content_warning, "warning", true);
            return;
        }
        // alert(txt_comment.value);

        jQuery.ajax({
            success: function (data) {
                studio_display_task_submit_message_rubric(content_info, "info", true);
            },
            method: "POST",

            data: {"comment": txt_comment.value},

            error: function (request, status, error) {
                studio_display_task_submit_message_rubric(content_danger, "danger", true);
            }
        })
    }
</script>

<style>
    .radio-btn-pad {
        margin-bottom: 5px;
    }

    .my-text-area {
        overflow: auto;
        resize: none;
        margin-bottom: 4px;
    }


</style>


