$def with (course, task_id, rubrica, data)

$var title: $:course.get_name(user_manager.session_language()) - Rubric Scoring

$var Column: $:template_helper.call('course_admin_menu',course=course,current='rubric_scoring')
$ is_admin = user_manager.has_admin_rights_on_course(course)

$def NavbarF():
    <ol class="nav navbar-nav nav-breadcrumb">
        <li><a href="$get_homepath()/course/$course.get_id()">$course.get_name(user_manager.session_language())</a></li>
        <li><a href="$get_homepath()/admin/$course.get_id()/rubric_scoring"><i class="fa fa-table mr-1"></i>$:_("Rubric Scoring")<span class="sr-only">(current)</span></a></li>
    <li><a href="$get_homepath()/admin/$course.get_id()/$data['url']/task/$task_id.get_id()">$:_("Task")</a></li>
    <li class="active"><a href="#">$:_("Student")<span class="sr-only">(current)</span></a></li>
    </ol>
$var Navbar: $:NavbarF()

<!-- CodeMirror -->
<h2 class="py-1">$:_("Rubric scoring for:") $data['username'] </h2>
<section class="py-2">
    <h4 class="py-1">$:_("Task"): $data['task_name']</h4>
    <div class="box">
    <label for="myTextCode"></label>
    <textarea class="single" id="myTextCode" rows="4" cols="10" data-language="$data['language']">$data['problem_id']</textarea>
    </div>
    <div id="task_alert" class="py-2"></div>
</section>

<!-- Information -->
<section>
    <h4 class="py-1">$:_("Information")</h4>
    <table class="table table-bordered">
        <tr>
            <td><b>$:_("Language")</b></td>
            <td>$data['language']</td>
            <td><b>$:_("Summary")</b></td>
            <td>$data['summary']</td>
        </tr>
        <tr>
            <td><b>$_("Score")</b></td>
            <td>$data['score']</td>
            <td><b>$_("Grade")</b></td>
            <td>$data['grade']</td>
        </tr>
    </table>
</section>
<!-- Rubric  -->
<section>
    <div class="py-1">
        <h4>$:_("Rubric Scoring")</h4>
        <p>$:_("Select the best description to grade the student's code")</p>
        <p>$:_("Click to select and double click to deselect")</p>
    </div>
    <div>
    <table class="table sorted_table table-bordered">
                <thead>
                <tr>
                    <th></th>
                    $for header in rubrica.keys():
                    <th>$header</th>
                </tr>
                </thead>
                <tbody>
                $ first_level = rubrica[list(rubrica.keys())[0]]

                $for category_index in range(len(first_level)):
                $ category_name = list(first_level[category_index])[0]
                <tr>
                    <th>$category_name</th>
                    $ col = 0
                    $for level_key in rubrica:
                    $ category_content = rubrica[level_key][category_index][category_name]
                    $ category_content = "" if category_content is None else category_content

                    $ category_content_lines = category_content.split("\n")
                    <td id="$category_index-$col">
                        $ col = col + 1
                        <ul>
                            $for line in category_content_lines:
                            <li>$line</li>
                        </ul>
                    </td>
                </tr>

                </tbody>
    </table>
        </div>
    <div>
        <strong><p id="output">Current Score: 0.0</p></strong>
    </div>
    <div id="grade_edit_submit_status"></div>
</section>
<!-- Comments -->
<section class="py-2">
    <form method="post">
        <h4 >$:_("Comments")</h4>
        <div class="py-1">
        <label for="text_comment"></label>
        <textarea class="form-control" id="text_comment" rows="8">$data['comment']</textarea>
            </div>
        <div>
            <a class="btn btn-primary" id="save_button" onclick="save()"><i class="fa fa-save mr-1"></i>$:_("Save")</a>
        </div>
    </form>
</section>

<!-- JS -->
<script type="text/javascript">

    function getAlertCode(content, type, dismissible) {
    let a = '<div class="alert fade in ';
    if(dismissible)
        a += 'alert-dismissible ';
    a += 'alert-' + type + '" role="alert">';
    if(dismissible)
        a += '<button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>';
    a += content;
    a += '</div>';
    return a;
    }

    function load_feedback_code() {

        let result = "$data['result']";
        let content = "$data['text']";
        let parser = new DOMParser();
        let doc = parser.parseFromString(content,'text/html');
        let alert_type = "danger";
        if(result === "timeout" || result === "overflow")
            alert_type = "warning";
        if(result === "success")
            alert_type = "success";
        document.getElementById('task_alert').innerHTML = getAlertCode(doc.body.innerText,alert_type,false);
    }
    load_feedback_code();
</script>

