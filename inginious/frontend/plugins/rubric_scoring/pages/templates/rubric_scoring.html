$def with (course, task_id, problem_id, rubrica, data)

$var title: $:course.get_name(user_manager.session_language()) - Rubric Scoring

$var Column: $:template_helper.call('course_admin_menu',course=course,current='rubric_scoring')
$ is_admin = user_manager.has_admin_rights_on_course(course)

$def NavbarF():
    <ol class="nav navbar-nav nav-breadcrumb">
        <li><a href="$get_homepath()/course/$course.get_id()">$course.get_name(user_manager.session_language())</a></li>
        <li><a href="$get_homepath()/admin/$course.get_id()/rubric_scoring"><i class="fa fa-table mr-1"></i>$:_("Rubric Scoring")<span class="sr-only">(current)</span></a></li>
    <li><a href="$get_homepath()/admin/$course.get_id()/$data['url']/task/$task_id.get_id()">$:_("Task")</a></li>
    <li class="active"><a href="#">$:_("Student")<span class="sr-only">(current)</span></a></li>
    </ol>
$var Navbar: $:NavbarF()

<!-- CodeMirror -->
<h2 class="py-1">$:_("Rubric scoring for:") $data['username'] </h2>
<section class="py-2">
    <h4 class="py-1">$:_("Task"): $data['task_name']</h4>
    <div class="box">
    <label for="myTextCode"></label>
    <textarea class="single" id="myTextCode" rows="4" cols="10">$data['problem_id']</textarea>
    </div>
    <div id="task_alert"></div>
</section>

<section>
    <h4 class="py-1">$:_("Information")</h4>
    <table class="table table-bordered">
        <tr>
            <td><b>$:_("Language")</b></td>
            <td>$data['language']</td>
            <td><b>$:_("Summary")</b></td>
            <td>$data['summary']</td>
        </tr>
        <tr>
            <td><b>$_("Score")</b></td>
            <td>$data['score']</td>
            <td><b>$_("Grade")</b></td>
            <td>$data['grade']</td>
        </tr>
    </table>
</section>
<section>
    <table class="table sorted_table table-bordered">
                <thead>
                <tr>
                    <th></th>
                    $for header in rubrica.keys():
                    <th>$header</th>
                </tr>
                </thead>
                <tbody>
                $ first_level = rubrica[list(rubrica.keys())[0]]

                $for category_index in range(len(first_level)):
                $ category_name = list(first_level[category_index])[0]
                <tr>
                    <th>$category_name</th>
                    $ col = 0
                    $for level_key in rubrica:
                    $ category_content = rubrica[level_key][category_index][category_name]
                    $ category_content = "" if category_content is None else category_content

                    $ category_content_lines = category_content.split("\n")
                    <td id="$category_index-$col">
                        $ col = col + 1
                        <ul>
                            $for line in category_content_lines:
                            <li>$line</li>
                        </ul>
                    </td>
                </tr>

                </tbody>
    </table>
    <div>
        <strong><p id="output">Current Score: 0.0</p></strong>
    </div>
</section>
<section class="py-2">
    <form method="post">
        <h4 >$:_("Comments")</h4>
        <div class="py-1">
        <label for="text_comment"></label>
        <textarea class="form-control" id="text_comment" rows="8">$data['comment']</textarea>
            </div>
        <div>
            <a class="btn btn-primary" id="save_button" onclick="save()">$:_("Save")</a>
        </div>
    </form>
</section>

<script>

    const languages = {
        "java7": "java",
        "java8": "java",
        "cpp": "cpp",
        "cpp11": "cpp",
        "c": "c",
        "c11": "c",
        "python3": "python",
        "vhdl": "vhdl",
        "verilog": "verilog"
    };



    let myTextArea = document.getElementById('myText');
    let score = 0.0;
    let language = languages["$data['language']"];
    let myCodeMirror = registerCodeEditor(document.getElementById("myTextCode"),language, 20);
    myCodeMirror.setSize(null, 300);
    myCodeMirror.setOption("readOnly","nocursor");

    let matrix = [];
    //Add listeners to squares
    for(let i = 0;i<5;i++){
        matrix[i]=[];
        for(let j = 0;j<5;j++){
            matrix[i][j] = document.getElementById(i+"-"+j);
            //Add function
            matrix[i][j].addEventListener('click', function (){
                removeSelectionOnRow(i);
                addClass(i+"-"+j);
                score += (j+1)*0.2;
                updateScore();
            });
            matrix[i][j].addEventListener('dblclick',function (){
                removeClass(i+"-"+j);
                score -= (j+1)*0.2;
                updateScore();
            });
            //Static, just change the cursor
             matrix[i][j].addEventListener('mouseover',function (){
                document.body.style.cursor = "pointer";
            });
            matrix[i][j].addEventListener('mouseout',function (){
                document.body.style.cursor = "default";
            });
        }
    }
    function removeClass(id){
        document.getElementById(id).classList.remove("box1");
    }
    function addClass(id){
        document.getElementById(id).classList.add("box1");
    }
    //
    function removeSelectionOnRow(row){
        for (let i = 0; i<5;i++){
            if (matrix[row][i].classList.contains("box1")){
                removeClass(`$${row}-$${i}`);
                score -= (i+1)*0.2;
                break;
            }
        }
    }
    function updateScore(){
        document.getElementById("output").innerHTML = "Current Score: "+ score.toFixed(1);
    }

    function save(){

    }


    //================================0
    //Reset all alerts
    function resetAlerts() {
    $$('#task_alert').html('');
    $$('.task_alert_problem').html('');
    }
    //Displays a loading alert in task form

    function getAlertCode(content, type, dismissible) {
    let a = '<div class="alert fade in ';
    if(dismissible)
        a += 'alert-dismissible ';
    a += 'alert-' + type + '" role="alert">';
    if(dismissible)
        a += '<button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>';
    a += content;
    a += '</div>';
    return a;
    }


</script>
<script>

    function load_feedback_code() {
        let result = "$data['result']";
        let content = "$data['text']";
        let parser = new DOMParser();
        let doc = parser.parseFromString(content,'text/html');


        console.log("=================================")
        console.log(result)
        console.log(content)
    let alert_type = "danger";
    if(result === "timeout" || result === "overflow")
        alert_type = "warning";
    if(result === "success")
        alert_type = "success";
    document.getElementById('task_alert').innerHTML = getAlertCode(doc.body.innerText,alert_type,false);
    }
    load_feedback_code();

</script>